# -*- coding: utf-8 -*-
"""modelo1_samsung.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1scWXX5zWbkbgsPIu2JGgdw9_oNdfiBPA
"""

import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.compose import ColumnTransformer
from sklearn.preprocessing import OneHotEncoder, StandardScaler
from sklearn.pipeline import Pipeline
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
import joblib

df = pd.read_csv("host_train.csv")

df.info()

def convert_stay_days(value):
    try:
        return int(value.split("-")[0])
    except:
        return None
df["Stay_Days"] = df["Stay_Days"].apply(convert_stay_days)
df["Stay_Block"] = df["Stay_Days"].apply(lambda x: 1 if x > 7 else 0)

df.dropna(inplace=True)

df['City_Code_Patient']

x = df.drop(columns=["Stay_Days", "case_id",'Stay_Block'])
y = df['Stay_Days']
y2 = df['Stay_Block']

x_train_l, x_test_l, y_train_l, y_test_l = train_test_split( x, y,
                                                    test_size=0.4,
                                                     random_state=20,
                                                     stratify=y)

x_train_rf, x_test_rf, y_train_rf, y_test_rf = train_test_split( x, y2,
                                                    test_size=0.4,
                                                     random_state=20,
                                                     stratify=y)

x_train_l.isnull().sum()

categorical_cols = [
    "Department",
    "Ward_Type",
    "Ward_Facility",
    "Type of Admission",
    "Illness_Severity",
    "Age"
]

numeric_cols = [
    "Hospital_type",
    "Hospital_city",
    "Hospital_region",
    "Available_Extra_Rooms_in_Hospital",
    "Bed_Grade",
    "Patient_Visitors",
    "City_Code_Patient",
    "Admission_Deposit"
]

preprocessor = ColumnTransformer(
    transformers=[
        ("cat", OneHotEncoder(handle_unknown="ignore"), categorical_cols),
        ("num", StandardScaler(), numeric_cols)
    ]
)

model_logist = Pipeline(steps=[
    ("preprocess", preprocessor),
    ("classifier", LogisticRegression(max_iter=200))
])

model_randomf = Pipeline(steps=[
    ("preprocess", preprocessor),
    ("classifier", RandomForestClassifier(random_state=42))
])

model_logist.fit(x_train_l, y_train_l)
model_randomf.fit(x_train_rf, y_train_rf)

joblib.dump(model_logist, "model_stay_day_logist.pkl")
joblib.dump(model_randomf, "model_block_day_randomf.pkl")

def predict_patient(data: dict):
    model_stay = joblib.load("model_stay.pkl")
    model_block = joblib.load("model_block.pkl")

    input_df = pd.DataFrame([data])

    stay_prediction = model_stay.predict(input_df)[0]
    block_prediction = model_block.predict(input_df)[0]

    return {
        "stay_days_prediction": stay_prediction,
        "block_prediction": int(block_prediction)
    }

#export the datasets to csv
pd.DataFrame(df).to_csv("Host_train.csv", index=False)
